/*!
Copyright (c) 2013 aaharu
This software is released under the MIT License.
https://raw.github.com/aaharu/gifken/master/LICENSE

This product includes following softwares:
* jsgif
- Copyright (c) 2011 Shachaf Ben-Kiki
- https://github.com/shachaf/jsgif
- https://raw.github.com/shachaf/jsgif/master/LICENSE
* GifWriter.js
- Copyright (c) 2013 NOBUOKA Yu
- https://github.com/nobuoka/GifWriter.js
- https://raw.github.com/nobuoka/GifWriter.js/master/LICENSE.txt
*/
var gifken;!function(a){function b(a,b){function c(){d=j+1,e=b+1,f=Object.create(null)}var d,e,f,g=new h,i=1<<b,j=i+1;c(),g.push(i,e);for(var k="",l=0,m=a.length;m>l;++l){var n=a[l],o=String.fromCharCode(n);o in f||(f[o]=n);var p=k;k+=o,k in f||(g.push(f[p],e),4095>=d?(f[k]=d,d===1<<e&&e++,d++):(g.push(i,e),c(),f[o]=n),k=o)}return g.push(f[k],e),g.push(j,e),g.flush()}var c=function(){function a(a){this.frames=[],a||(this._standard="GIF89a",this._width=1,this._height=1,this.colorResolution=112,this.sortFlag=!1,this.bgColorIndex=1,this.pixelAspectRatio=0,this.globalColorTable=e.createColorTable([new e(0,0,0),new e(255,255,255)]))}return a.parse=function(b){for(var c=new a(!0),d=new DataView(b),e=f.readHeader(c,d);;)if(e=f.readBlock(c,d,e),-1===e)break;return c},Object.defineProperty(a.prototype,"standard",{get:function(){return this._standard},set:function(a){if("GIF89a"!==a&&"GIF87a"!==a)throw new Error("failed gif format");this._standard=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"width",{get:function(){return this._width},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("width range error: "+a);this._width=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return this._height},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("height range error: "+a);this._height=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalColorTable",{set:function(a){this._globalColorTable=a,this._globalTableSize=a.byteLength/3,void 0===this.bgColorIndex&&(this.bgColorIndex=this._globalTableSize-1)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalTableSize",{get:function(){return this._globalTableSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"loopCount",{get:function(){return this._loopCount},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("loopCount range error: "+a);this._loopCount=a},enumerable:!0,configurable:!0}),a.prototype.writeToBlob=function(){var a=[],c=new DataView(new ArrayBuffer(13));c.setUint8(0,71),c.setUint8(1,73),c.setUint8(2,70),c.setUint8(3,56),"GIF89a"===this._standard?c.setUint8(4,57):c.setUint8(4,55),c.setUint8(5,97),c.setUint16(6,this._width,!0),c.setUint16(8,this._height,!0);var d=0;if(this._globalTableSize>0){d|=128;var e=0,f=this._globalTableSize;do f>>=1,++e;while(f>1);d|=e-1}if(d|=this.colorResolution,this.sortFlag&&(d|=8),c.setUint8(10,d),c.setUint8(11,this.bgColorIndex),c.setUint8(12,this.pixelAspectRatio),a.push(c),this._globalTableSize>0&&a.push(this._globalColorTable),this.isLoop){var g=new DataView(new ArrayBuffer(19));g.setUint8(0,33),g.setUint8(1,255),g.setUint8(2,11),g.setUint8(3,78),g.setUint8(4,69),g.setUint8(5,84),g.setUint8(6,83),g.setUint8(7,67),g.setUint8(8,65),g.setUint8(9,80),g.setUint8(10,69),g.setUint8(11,50),g.setUint8(12,46),g.setUint8(13,48),g.setUint8(14,3),g.setUint8(15,1),g.setUint16(16,this._loopCount,!0),g.setUint8(18,0),a.push(g)}return this.frames.forEach(function(c){var d=new DataView(new ArrayBuffer(18));if(d.setUint8(0,33),d.setUint8(1,249),d.setUint8(2,4),c.transparentFlag?d.setUint8(3,1):d.setUint8(3,0),d.setUint16(4,c.delayCentiSeconds,!0),d.setUint8(6,c.transparentColorIndex),d.setUint8(7,0),d.setUint8(8,44),d.setUint16(9,c.x,!0),d.setUint16(11,c.y,!0),d.setUint16(13,c.width,!0),d.setUint16(15,c.height,!0),c.localTableSize>0){var e=0,f=c.localTableSize;do f>>=1,++e;while(f>1);d.setUint8(17,128|e-1)}else d.setUint8(17,0);if(a.push(d),c.localTableSize>0&&a.push(c.localColorTable),a.push(new Uint8Array([c.lzwCode])),void 0===c.compressedData&&void 0===c.pixelData)throw new Error("no image data");var g=0,h=c.compressedData;h=h||new Uint8Array(b(c.pixelData,c.lzwCode));for(var i=h.length;;){if(!(i>g+255)){var j=h.subarray(g);a.push(new Uint8Array([j.byteLength])),a.push(j);break}a.push(new Uint8Array([255])),a.push(h.subarray(g,g+255)),g+=255}a.push(new Uint8Array([0]))}),a.push(new Uint8Array([59])),new Blob(a,{type:"image/gif"})},a.prototype.split=function(c){var d=this,e=[];return c?this.frames.forEach(function(c,f){var g=new a;if(g.standard=d._standard,g.width=d._width,g.height=d._height,g.colorResolution=d.colorResolution,g.sortFlag=d.sortFlag,g.bgColorIndex=d.bgColorIndex,g.pixelAspectRatio=d.pixelAspectRatio,g.globalColorTable=d._globalColorTable,0!==f&&c.transparentFlag){void 0===c.pixelData&&c.decompress(),void 0===d.frames[f-1].pixelData&&d.frames[f-1].decompress();for(var h=0,i=c.pixelData.length;i>h;++h)c.pixelData[h]===c.transparentColorIndex&&(c.pixelData[h]=d.frames[f-1].pixelData[h]);var j=b(c.pixelData,c.lzwCode);c.compressedData=new Uint8Array(j)}g.frames=[c],e.push(g)}):this.frames.forEach(function(b){var c=new a;c.standard=d._standard,c.width=d._width,c.height=d._height,c.colorResolution=d.colorResolution,c.sortFlag=d.sortFlag,c.bgColorIndex=d.bgColorIndex,c.pixelAspectRatio=d.pixelAspectRatio,c.globalColorTable=d._globalColorTable,c.frames=[b],e.push(c)}),e},a.prototype.playback=function(c){var d=this,e=new a;return c&&this.frames.forEach(function(a,c){if(0!==c&&a.transparentFlag){void 0===a.pixelData&&a.decompress(),void 0===d.frames[c-1].pixelData&&d.frames[c-1].decompress();for(var e=0,f=a.pixelData.length;f>e;++e)a.pixelData[e]===a.transparentColorIndex&&(a.pixelData[e]=d.frames[c-1].pixelData[e]);var g=b(a.pixelData,a.lzwCode);a.compressedData=new Uint8Array(g)}}),e.standard=this._standard,e.width=this._width,e.height=this._height,e.colorResolution=this.colorResolution,e.sortFlag=this.sortFlag,e.bgColorIndex=this.bgColorIndex,e.pixelAspectRatio=this.pixelAspectRatio,e.globalColorTable=this._globalColorTable,e.frames=this.frames.reverse(),e.isLoop=this.isLoop,e.loopCount=this._loopCount,e},a}();a.Gif=c;var d=function(){function a(a){this._parent=a}return a.init=function(b){var c=new a(b);return c.transparentFlag=!1,c.delayCentiSeconds=0,c.transparentColorIndex=0,c.x=0,c.y=0,c.width=b.width||1,c.height=b.height||1,c.localTableSize=0,c.lzwCode=4,c.pixelData=new Uint8Array(c.width*c.height),c},a.prototype.decompress=function(){this.pixelData=g(this.lzwCode,this.compressedData,this.width*this.height)},a}();a.Frame=d;var e=function(){function a(a,b,c){this.r=a,this.g=b,this.b=c}return a.valueOf=function(){},a.createColorTable=function(b){for(var c=[],d=1;8>=d;++d)for(var e=(d<<1)-b.length,f=0;e>f;++f)b.push(new a(255,255,255));return b.forEach(function(a){c.push(a.r),c.push(a.g),c.push(a.b)}),new Uint8Array(c)},a}();a.Color=e;var f=function(){function a(){}return a.readHeader=function(a,b){a.standard=String.fromCharCode(b.getUint8(0),b.getUint8(1),b.getUint8(2),b.getUint8(3),b.getUint8(4),b.getUint8(5)),a.width=b.getUint16(6,!0),a.height=b.getUint16(8,!0);var c,d=b.getUint8(10),e=128&d;return c=128!==e?0:1<<(7&d)+1,a.colorResolution=112&d,a.sortFlag=8===(8&d)?!0:!1,a.bgColorIndex=b.getUint8(11),a.pixelAspectRatio=b.getUint8(12),128!==e?13:(a.globalColorTable=new Uint8Array(b.buffer,13,3*c),13+3*c)},a.readBlock=function(a,b,c){var e=b.getUint8(c);if(59===e)return-1;if(33===e){var f=b.getUint8(c+1);if(249===f){var g=new d(a);return c=this.readGraphicControlExtensionBlock(a,b,c,g),c=this.readImageBlock(a,b,c,g),a.frames.push(g),c}if(254===f)return c=this.readCommentExtensionBlock(a,b,c);if(255===f)return c=this.readApplicationExtensionBlock(a,b,c);if(1===f)return c=this.readPlainTextExtensionBlock(a,b,c)}if(44===e){var g=new d(a);return c=this.readImageBlock(a,b,c,g),a.frames.push(g),c}return-1},a.readImageBlock=function(a,b,c,d){d.x=b.getUint16(++c,!0),c+=2,d.y=b.getUint16(c,!0),c+=2,d.width=b.getUint16(c,!0),c+=2,d.height=b.getUint16(c,!0),c+=2;var e=b.getUint8(c++),f=128&e;128===f?(d.localTableSize=1<<(7&e)+1,d.localColorTable=new Uint8Array(b.buffer,c,3*d.localTableSize),c+=3*d.localTableSize):d.localTableSize=0,d.lzwCode=b.getUint8(c++);for(var g=new Array,h=0;;){var i=b.getUint8(c++);if(h+=i,0===i)break;g.push(new Uint8Array(b.buffer.slice(c,c+i))),c+=i}var j=new Uint8Array(h);j.set(g[0],0);for(var k=g[0].byteLength,l=1,m=g.length;m>l;++l)j.set(g[l],k),k+=g[l].byteLength;return d.compressedData=j,c},a.readApplicationExtensionBlock=function(a,b,c){if(c+=2,11!==b.getUint8(c++))throw new Error("faild: _readApplicationExtensionBlock");var d=String.fromCharCode(b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++));if("NETSCAPE2.0"===d){if(a.isLoop=!0,3!==b.getUint8(c++))throw new Error("faild: _readApplicationExtensionBlock (NETSCAPE2.0)");++c,a.loopCount=b.getUint16(c,!0),c+=2}for(;;){var e=b.getUint8(c++);if(0===e)break;c+=e}return c},a.readCommentExtensionBlock=function(a,b,c){for(c+=2;;){var d=b.getUint8(c++);if(0===d)break;c+=d}return c},a.readGraphicControlExtensionBlock=function(a,b,c,d){var e=b.getUint8(c+3);return d.transparentFlag=1===(1&e),d.delayCentiSeconds=b.getUint16(c+4,!0),d.transparentColorIndex=b.getUint8(c+6),c+8},a.readPlainTextExtensionBlock=function(a,b,c){for(c+=2;;){var d=b.getUint8(c++);if(0===d)break;c+=d}return c},a}(),g=function(a,b,c){for(var d,e,f=0,g=function(a){for(var c=0,d=0;a>d;++d)b[f>>3]&1<<(7&f)&&(c|=1<<d),++f;return c},h=new Uint8Array(c),i=1<<a,j=i+1,k=a+1,l=[],m=function(){l=[],k=a+1;for(var b=0;i>b;++b)l[b]=[b];l[i]=[],l[j]=null},n=0;;)if(e=d,d=g(k),d!==i){if(d===j)break;if(d<l.length)e!==i&&l.push(l[e].concat(l[d][0]));else{if(d!==l.length)throw new Error("Invalid LZW code.");l.push(l[e].concat(l[e][0]))}h.set(l[d],n),n+=l[d].length,l.length===1<<k&&12>k&&k++}else m();return h},h=function(){function a(){this.__out=[],this.__remNumBits=0,this.__remVal=0}return a.prototype.push=function(a,b){for(;b>0;)this.__remVal=(255&a<<this.__remNumBits)+this.__remVal,b+this.__remNumBits>=8?(this.__out.push(this.__remVal),b-=8-this.__remNumBits,a>>=8-this.__remNumBits,this.__remVal=0,this.__remNumBits=0):(this.__remNumBits=b+this.__remNumBits,b=0)},a.prototype.flush=function(){this.push(0,8),this.__remNumBits=0,this.__remVal=0;var a=this.__out;return this.__out=[],a},a}()}(gifken||(gifken={}));